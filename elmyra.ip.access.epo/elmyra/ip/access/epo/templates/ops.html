## -*- coding: utf-8 -*-
## (c) 2013-2015 Andreas Motl, Elmyra UG

## ------------------------------------------
##   ops document collection template
## ------------------------------------------
<script id="ops-collection-template" type="text/x-underscore-template">
    <!--
    <div id="ops-collection-entry" class="row"/>
    -->
</script>



## ------------------------------------------
##   ops document item template
## ------------------------------------------
<script id="ops-entry-template" type="text/x-underscore-template">

    <%text>
    <%

    // 1. debugging: log model item to assist in data exploration
    //console.log('ops-item:', data);

    var meta = data['__meta__'];

    // 2.2 prepare some template variables

    var patent_number = data.get_patent_number();
    var linkmaker = data.get_linkmaker();
    var publication_date = data.get_publication_date();
    var application_date = data.get_application_date();

    var title_list = data.get_title_list();
    var abstract_list = data.get_abstract_list();

    %>
    </%text>


    <%text>
    <div class="container-fluid ops-collection-entry page-break-after" data-document-number="<%= patent_number %>">

        <div class="ops-collection-entry-heading row-fluid">

            <!-- patent number -->
            <div class="span3 container-fluid">
                <div class="header-compact">
                    <%= data.enrich_link(patent_number, 'pn', null, null, {'no_modifiers': true}) %>
                </div>
                <%
                if (meta && meta['swapped'] && meta['swapped']['canonical']) {
                    print('<div style="margin-top: 0.5em">');
                    print('Original hit: ');
                    print(data.enrich_link(meta['swapped']['canonical'], 'pn', null, null, {'no_modifiers': true}));
                    print('</div>');
                }
                %>
            </div>

            <!-- dates -->
            <div class="span2 container-fluid">
                <div class="header-biblio">
                    <span class="inid inid-tooltip" data-toggle="tooltip" title="publication date">(40)</span>
                    &nbsp;
                    <span><%= data.enrich_link(publication_date, 'publicationdate') %></span>
                </div>
            </div>

            <!-- actions -->
            <div class="span7 container-fluid document-actions do-not-print">

                <!-- details / fulltext -->
                <div class="span9">

                    <div class="span8">

                    <div class="btn-group btn-popover tabs document-details-chooser"
                         data-toggle="popover" data-trigger="hover" data-placement="top"
                         data-content="Toggle detail view"
                         >
                        <button class="btn active" data-toggle="tab"
                                href="#document-details-biblio-container-<%= patent_number %>">
                            Biblio
                        </button>
                        <% if (data.has_fulltext()) { %>
                        <button class="btn" data-toggle="tab"
                                href="#document-details-claims-container-<%= patent_number %>"
                                data-details-type="claims"
                                >
                            Claims
                        </button>
                        <button class="btn" data-toggle="tab"
                                href="#document-details-description-container-<%= patent_number %>"
                                data-details-type="description"
                                >
                            Desc
                        </button>
                        <% } %>
                        <button class="btn" data-toggle="tab"
                                id="document-details-family-button-<%= patent_number %>"
                                href="#document-details-family-container-<%= patent_number %>"
                                data-details-type="family"
                                >
                            Family
                        </button>
                    </div>

                    </div>


                    <div class="span4">

                    <span id="region-comment-button"/>

                    <!-- pdf document -->
                    <a href="<%= linkmaker.universal_pdf_url() %>" target="ipsuite-pdf"
                        class="btn btn-popover anchor-pdf" role="button"
                        data-toggle="popover" data-trigger="hover" data-placement="top"
                        data-content="PDF document"
                        >
                        <%= opsChooserApp.ui.pdf_icon() %>
                    </a>

                    <!-- external links -->
                    <div class="btn-group btn-popover external-links"
                         data-toggle="popover" data-trigger="hover" data-placement="top"
                         data-content="Show more information from domestic patent offices and other sources"
                         >
                        <a class="btn dropdown-toggle" data-toggle="dropdown">
                            <i class="icon-globe icon-large"></i>
                        </a>
                        <ul class="dropdown-menu">

                            <!-- bibliographic data -->
                            <li><div style="padding-left: 10px">
                                <h5><i class="icon-list"></i> &nbsp; Bibliographic data</h5>
                            </div>
                            </li>
                            <li>
                                <a href="<%= linkmaker.espacenet_worldwide_url() %>" target="_blank" class="anchor-biblio-espacenet">
                                    [BIBLIO] <%= patent_number %> @ Espacenet
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.depatisnet_url() %>" target="_blank" class="anchor-biblio-depatisnet">
                                    [BIBLIO] <%= patent_number %> @ DEPATISnet
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.google_url() %>" target="_blank" class="anchor-biblio-google">
                                    [BIBLIO] <%= patent_number %> @ Google Patents
                                </a>
                            </li>

                            <% if (linkmaker.country == 'US') { %>
                            <li>
                                <a href="<%= linkmaker.uspto_appft_biblio() %>" target="_blank" class="anchor-biblio-uspto-appft">
                                    [BIBLIO] <%= patent_number %> @ USPTO AppFT
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.uspto_patft_biblio() %>" target="_blank" class="anchor-biblio-uspto-patft">
                                    [BIBLIO] <%= patent_number %> @ USPTO PatFT
                                </a>
                            </li>
                            <% } %>

                            <% if (linkmaker.country == 'WO') { %>
                            <li>
                                <a href="<%= linkmaker.wipo_biblio() %>" target="_blank" class="anchor-biblio-wipo">
                                    [BIBLIO] <%= patent_number %> @ WIPO
                                </a>
                            </li>
                            <% } %>

                            <% if (linkmaker.country == 'CA') { %>
                            <li>
                                <a href="<%= linkmaker.cipo_biblio() %>" target="_blank" class="anchor-biblio-cipo">
                                    [BIBLIO] <%= patent_number %> @ CIPO
                                </a>
                            </li>
                            <% } %>

                            <li class="divider"/>


                            <!-- legal status -->
                            <li><div style="padding-left: 10px">
                                <h5>§ &nbsp; Legal information</h5>
                            </div>
                            </li>
                            <li>
                                <a href="<%= linkmaker.inpadoc_legal_url() %>" target="_blank">
                                    [LEGAL] <%= patent_number %> @ INPADOC legal status
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.epo_register_url() %>" target="_blank" class="anchor-register-epo">
                                    [LEGAL] <%= patent_number %> @ European Patent Register
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.dpma_register_url() %>" target="_blank" class="anchor-register-dpma">
                                    [LEGAL] <%= patent_number %> @ DPMAregister
                                </a>
                            </li>
                            <% if (linkmaker.country == 'US') { %>
                            <li>
                                <a href="<%= linkmaker.uspto_pair_url() %>" target="_blank">
                                    [LEGAL] USPTO PAIR
                                </a>
                            </li>
                            <% } %>
                            <li class="divider"/>


                            <!-- patent family -->
                            <li><div style="padding-left: 10px">
                                <h5><i class="icon-group"></i> &nbsp; Patent family information</h5>
                            </div>
                            </li>
                            <li>
                                <a href="<%= linkmaker.ccd_viewer_url() %>" target="_blank" class="anchor-ccd">
                                    [FAMILY] <%= patent_number %> @ CCD Viewer
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.inpadoc_family_url() %>" target="_blank">
                                    [FAMILY] <%= patent_number %> @ INPADOC patent family
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.ops_family_url() %>" target="_blank">
                                    [FAMILY] <%= patent_number %> @ OPS biblio,legal
                                </a>
                            </li>
                            <li class="divider"/>


                            <!-- PDF -->
                            <li><div style="padding-left: 10px">
                                <h5><%= opsChooserApp.ui.pdf_icon() %> &nbsp; PDF and Images</h5>
                            </div>
                            </li>
                            <li>
                                <a href="<%= linkmaker.ops_pdf_url() %>" target="ipsuite-pdf" class="anchor-pdf-ops">
                                    [PDF] <%= patent_number %> @ OPS
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.espacenet_pdf_url() %>" target="ipsuite-pdf">
                                    [PDF] <%= patent_number %> @ Espacenet
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.depatisnet_pdf_url() %>" target="ipsuite-pdf">
                                    [PDF] <%= patent_number %> @ DEPATISnet
                                </a>
                            </li>

                            <% if (linkmaker.country == 'US') { %>
                            <li>
                                <a href="<%= linkmaker.uspto_appft_images() %>" target="_blank" class="anchor-images-uspto-appft">
                                    [PDF] <%= patent_number %> @ USPTO AppFT
                                </a>
                            </li>
                            <li>
                                <a href="<%= linkmaker.uspto_patft_images() %>" target="_blank" class="anchor-images-uspto-patft">
                                    [PDF] <%= patent_number %> @ USPTO PatFT
                                </a>
                            </li>
                            <% } %>

                            <li class="divider"/>


                            <!-- Research -->
                            <li><div style="padding-left: 10px">
                                <h5><i class="icon-fullscreen"></i> &nbsp; Research</h5>
                            </div>
                            </li>
                            <li>
                                <a href="<%= linkmaker.google_prior_art_url() %>" target="_blank">
                                    [PRIOR ART] <%= patent_number %> @ Google Prior Art Finder
                                </a>
                            </li>

                        </ul>
                    </div>

                    </div>

                    </%text>


                </div>

                <!-- add/remove -->
                <div class="span3" style="line-height: 200%">

                    <%
                    # FIXME: use javascript-only variables, get rid of the pyramid request object
                    ship_mode = request.params.get('ship-mode', 'multi-numberlist')
                    %>

                    % if ship_mode == 'multi-numberlist':
                    <%text>
                    <span class="pull-right">
                    <a id="remove-patent-number-<%= patent_number %>" role="button" class="btn-popover incognito remove-patent-number pointer"
                       data-patent-number="<%= patent_number %>"
                       data-toggle="popover" data-trigger="hover" data-placement="top" data-content="Remove document number from collection"
                            ><i class="icon-trash icon-large"></i></a>
                    &nbsp;
                    <span
                            class="rating-widget"
                            id="rate-patent-number-<%= patent_number %>"
                            data-document-number="<%= patent_number %>"
                            style="display: inline-block;"
                            ></span>
                    </span>
                    <input type="checkbox" id="chk-patent-number-<%= patent_number %>" class="chk-patent-number hide" value="<%= patent_number %>"/>
                    <!--
                    <a id="add-patent-number-<%= patent_number %>" role="button" class="btn btn-popover add-patent-number"
                       data-patent-number="<%= patent_number %>"
                       data-toggle="popover" data-trigger="hover" data-placement="top" data-content="Add document number to collection"
                       >
                        <i class="icon-white icon-plus"></i>
                    </a>
                    -->

                    </%text>
                    % endif

                    % if ship_mode == 'single-bibdata':
                    <%text>
                    <form name="single-bibdata-<%= patent_number %>" method="post" action="<%= data.config.get('ship-url') %>" target="<%= data.config.get('ship-frame') %>" class="form-single-bibdata">
                        <input name="query" type="hidden" value="<%= $('#query').val().replace(/"/g, '&quot;') %>"/>
                        <input name="patent_number" type="hidden" value="<%= patent_number %>"/>
                        <input name="title" type="hidden" value="<%= title_list.join('\n') %>"/>
                        <input name="applicants" type="hidden" value="<%= data.get_applicants().join('\n') %>"/>
                        <input name="inventors" type="hidden" value="<%= data.get_inventors().join('\n') %>"/>
                        <input name="application_date" type="hidden" value="<%= application_date %>"/>
                        <input name="publication_date" type="hidden" value="<%= publication_date %>"/>
                        <input name="ipcs" type="hidden" value="<%= data.get_ipcr_list().join('\n') %>"/>
                        <input name="abstract" type="hidden" value="<%= abstract_list.join('\n') %>"/>
                        <!--
                        <input name="ship_action" type="submit" value="rate" class="btn"/>
                        -->
                        <button type="submit" role="button" class="btn btn-popover"
                                data-toggle="popover" data-trigger="hover" data-placement="bottom"
                                data-content="Submit details of document to origin or 3rd-party system"
                                >
                            <i class="icon-share"/>
                            Submit
                        </button>

                    </form>
                    </%text>
                    % endif

                    <%text>

                </div>

            </div>

        </div>

        <span id="region-comment-text"/>

        <div class="ops-collection-entry-inner container-fluid ops-bibliographic-details">

            <div class="row-fluid">
                <div class="span12 keyword">
                    <strong><%= title_list.join('<br/>') %></strong>
                </div>
            </div>

            <div class="row-fluid">
                <div class="span5">

                    <!-- second header -->
                    <!-- for letting the drawing follow the text -->
                    <!--
                    <div class="ops-collection-entry-heading-second well span4 hide">second heading</div>
                    -->

                    <!-- first drawing only -->
                    <!--
                    <img src="<% //linkmaker.drawing_url() %>" alt="No drawing available."/>
                    -->

                    <!-- carousel for all drawings -->
                    <div id="drawings-carousel-<%= patent_number %>" class="carousel slide drawings-carousel">
                        <!--
                        <ol class="carousel-indicators">
                            <li data-target="#drawings-carousel" data-slide-to="0" class="active"></li>
                            <li data-target="#drawings-carousel" data-slide-to="1"></li>
                            <li data-target="#drawings-carousel" data-slide-to="2"></li>
                        </ol>
                        -->
                        <!-- carousel items -->
                        <div class="carousel-inner">
                            <div class="active item">
                                <img src="<%= linkmaker.drawing_url() %>"
                                     alt="No drawing available."
                                     onload="$(this).closest('.ops-collection-entry').prop('view').signalDrawingLoaded();"/>
                            </div>
                        </div>
                        <!-- carousel navigation -->
                        <a class="carousel-control left  do-not-print" href="#drawings-carousel-<%= patent_number %>" data-slide="prev">&lsaquo;</a>
                        <a class="carousel-control right do-not-print" href="#drawings-carousel-<%= patent_number %>" data-slide="next">&rsaquo;</a>
                    </div>

                    <div class="drawing-info span12 text-center">
                        Drawing #<span class="drawing-number">1</span><span class="drawing-totalcount"/>
                    </div>

                </div>
                <div class="span7 tab-content document-details">

                    <div id="document-details-biblio-container-<%= patent_number %>" class="tab-pane fade in active">
                    <dl class="dl-horizontal dl-horizontal-biblio">

                        <dt class="inid-tooltip" data-toggle="tooltip" title="applicants">
                            (71)
                        </dt>
                        <dd class="keyword">
                            <%=
                            data.get_applicants(true).map(function(item) {
                                return _.template($('#ops-biblio-party-template').html(), item);
                            }).join('<br/>') || '&nbsp;'
                            %>
                        </dd>

                        <dt class="inid-tooltip" data-toggle="tooltip" title="inventors">
                            (72)
                        </dt>
                        <dd class="keyword">
                            <%=
                            data.get_inventors(true).map(function(item) {
                                return _.template($('#ops-biblio-party-template').html(), item);
                            }).join('<br/>') || '&nbsp;'
                            %>
                        </dd>
                        <br/>

                        <dt class="inid-tooltip" data-toggle="tooltip" title="application / domestic filing">
                            (20)
                        </dt>
                        <dd class="keyword">
                            <table class="table table-striped2 table-condensed">
                                <tr>
                                <%= data.get_application_references() %>
                                </tr>
                            </table>
                        </dd>
                        <dt class="inid-tooltip" data-toggle="tooltip" title="priority application">
                            (30)
                        </dt>
                        <dd class="keyword">
                            <% var priority_claims_rendered = data.get_priority_claims(true).map(function(item) { return '<tr>' + item + '</tr>'; }).join(''); %>
                            <table class="table table-striped2 table-condensed">
                                <%= priority_claims_rendered %>
                            </table>
                        </dd>
                        <br/>

                        <dt class="inid-tooltip" data-toggle="tooltip" title="classifications">
                            (51)
                        </dt>
                        <dd class="dl-horizontal-inline-container">
                            <span class="clearfix"></span>
                            <dl class="dl-horizontal2 dl-horizontal-inline">

                            <% if (data.has_ipc() || data.has_ipcr() || data.has_classifications()) { %>

                                <% if (data.has_ipc()) { %>
                                <dt>
                                    IPC
                                </dt>
                                <dd class="keyword">
                                    <%= data.get_ipc_list(true).join(', ') || '&nbsp;' %>
                                </dd>
                                <% } %>

                                <% if (data.has_ipcr()) { %>
                                <dt>
                                    IPC-R
                                </dt>
                                <dd class="keyword">
                                    <%= data.get_ipcr_list(true).join(', ') || '&nbsp;' %>
                                </dd>
                                <% } %>


                                <%
                                var classifications_map = data.get_classifications(true);
                                var classification_schemes = data.get_classification_schemes();
                                %>

                                <%
                                _(classification_schemes).each(function(classification_scheme) {
                                %>

                                    <%
                                    if (!_.isEmpty(classifications_map[classification_scheme])) {
                                    %>
                                    <dt>
                                        <%= classification_scheme %>
                                    </dt>
                                    <dd class="keyword">
                                        <%= classifications_map[classification_scheme].join(', ') || '&nbsp;' %>
                                    </dd>
                                    <% } %>

                                <% }); %>

                            <% } else { %>
                            Classifications not available
                            <% } %>

                            </dl>
                        </dd>

                        <dt class="inid-tooltip" data-toggle="tooltip" title="references cited">
                            (56)
                        </dt>
                        <dd class="keyword">
                            <% if (data.has_citations()) { %>
                                <%= data.get_patent_citation_list(true).join(', ') || 'Citations empty' %>
                            <% } else { %>
                                Citations not available
                            <% } %>
                            <br/>
                            <%= data.get_citations_environment_button() %>
                            <a class="btn btn-small family-citations-shortcut-button do-not-print" role="button">
                                Family » Citations &nbsp; <i class="icon-arrow-right"></i>
                            </a>
                        </dd>
                        <br/>

                        <dt class="inid-tooltip" data-toggle="tooltip" title="abstract">
                            (57)
                        </dt>
                        <dd class="keyword">
                            <div class="abstract">
                                <%= abstract_list.join('<br/><br/>') || 'Abstract not available' %>
                            </div>
                        </dd>
                        <br/>

                        <dt class="inid-tooltip" data-toggle="tooltip" title="full cycle">
                            (F)
                        </dt>
                        <dd class="keyword">
                            Full cycle:
                            <br/>
                            <% _(data.get_full_cycle()).each(function(entry) { %>

                                <%= entry.attributes.get_patent_number() %>,
                                <%= entry.attributes.get_publication_date() %>
                                <span class="inid inid-tooltip" data-toggle="tooltip" title="publication date">(45)</span>

                                &nbsp;&nbsp;

                                <!-- pdf document -->
                                <a href="<%= linkmaker.universal_pdf_url(entry.attributes.get_patent_number()) %>" target="ipsuite-pdf"
                                   class="btn btn-small btn-popover anchor-pdf do-not-print" role="button"
                                   data-toggle="popover" data-trigger="hover" data-placement="top"
                                   data-content="PDF document"
                                        >
                                    <%= opsChooserApp.ui.pdf_icon() %>
                                </a>

                                <br/>

                            <% }); %>

                        </dd>
                        <br/>

                        <% var npl_citations_rendered = data.get_npl_citation_list().map(function(item) { return '<tr><td>' + item + '</td></tr>'; }).join('') %>
                        <% if (npl_citations_rendered) { %>
                        <dt class="inid-tooltip" data-toggle="tooltip" title="non-patent-literature references cited">
                            (N)
                        </dt>
                        <dd class="keyword">
                            <table class="table table-striped table-condensed">
                                <%= npl_citations_rendered %>
                            </table>
                        </dd>
                        <br/>
                        <% } %>

                    </dl>
                    </div>

                    <div id="document-details-claims-container-<%= patent_number %>" class="tab-pane fade" style="margin-top: 1em">
                        <strong>Claims</strong> <span class="document-details-language"></span>
                        &nbsp;&nbsp;&nbsp;<i class="document-details-spinner icon-refresh icon-spin" style="display: none"></i>
                        <br/><br/>
                        <span class="document-details-content keyword"></span>
                    </div>

                    <div id="document-details-description-container-<%= patent_number %>" class="tab-pane fade" style="margin-top: 1em">
                        <strong>Description</strong> <span class="document-details-language"></span>
                        &nbsp;&nbsp;&nbsp;<i class="document-details-spinner icon-refresh icon-spin" style="display: none"></i>
                        <br/><br/>
                        <span class="document-details-content keyword"></span>
                    </div>

                    <div id="document-details-family-container-<%= patent_number %>" class="tab-pane fade" style="margin-top: 1em">
                        <strong>Patent family</strong>
                        &nbsp;&nbsp;&nbsp;
                        <div class="btn-group tabs family-chooser">
                            <button class="btn btn-small active" data-toggle="tab" data-view-type="compact">
                                Compact
                            </button>
                            <button class="btn btn-small" data-toggle="tab" data-view-type="verbose">
                                Verbose
                            </button>
                            <% if (opsChooserApp.user_has_module('family-citations')) { %>
                            <button class="btn btn-small" data-toggle="tab" data-view-type="citations">
                                Citations
                            </button>
                            <% } %>
                        </div>
                        &nbsp;&nbsp;&nbsp;
                        <i class="document-details-spinner icon-refresh icon-spin" style="display: none"></i>
                        <br/><br/>
                        <span class="document-details-content keyword"></span>
                    </div>

                    <!-- embed 3rd-party component -->
                    <div class="embed-item" data-embed-url="<%= data.config.get('embed-item-url') %>" data-document-number="<%= patent_number %>">
                    </div>

                </div>
            </div>

        </div>

    </div>
    </%text>

</script>


<%text>
<script id="ops-entry-error-template" type="text/x-underscore-template">

    <%
    var patent_number = get_patent_number();
    var subject = 'Problem when displaying document ' + patent_number;
    var body = 'We experienced an error when displaying the document ' + patent_number + ', which is important to us. Please have a look at this problem.';
    %>

    <div class="container-fluid ops-collection-entry page-break-after" data-document-number="<%= patent_number %>">

        <div class="ops-collection-entry-heading row-fluid">

            <!-- patent number -->
            <div class="span3 container-fluid">
                <div class="header-compact">
                    <%= enrich_link(patent_number, 'pn') %>
                </div>
            </div>

            <!-- actions -->
            <div class="span7 container-fluid document-actions">
                <div class="alert alert-error alert-block">
                    En error occurred when displaying this document:
                    <br/>
                    <%= error_message %>
                    <br/><br/>
                    <a href="mailto:support@elmyra.de?subject=<%= encodeURIComponent('Elmyra IP Suite Navigator: ' + subject)%>&body=<%= encodeURIComponent(body) %>" role="button" class="btn">Help to improve the system</a>
                </div>
            </div>

        </div>

    </div>

</script>
</%text>


<%text>
<!-- citation queries -->
<script type="text/x-underscore-template" id="ops-citations-environment-button-template">

    <div class="btn-group btn-popover do-not-print"
         data-toggle="popover" data-trigger="hover" data-placement="top"
         data-content="Explore citation environment"
            >
        <button class="btn btn-small dropdown-toggle" data-toggle="dropdown">
            <i class="icon-search"></i>
        </button>
        <button class="btn btn-small dropdown-toggle" data-toggle="dropdown">
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
            <% if (data.has_citations()) { %>
            <%
            var citations_list  = data.get_patent_citation_list(false, 'epodoc', options);
            var citations_comma = citations_list.join(',');
            %>
            <li>
                <a href="?numberlist=<%= encodeURIComponent(citations_comma) %>" class="query-link" target="_blank">
                    Documents cited: pn in (56)
                </a>
            </li>
            <!--
            <li>
                <a href="?numberlist=<%= encodeURIComponent('ct=' + citations_comma) %>" class="query-link" target="_blank">
                    Documents citing same citations: ct in (56)
                </a>
            </li>
            -->
            <li>
                <a href="?query=<%= encodeURIComponent(data.get_same_citations_query(options)) %>"
                   class="query-link same-citations-link" data-length="<%= citations_list.length %>" target="_blank">
                    Documents citing same citations: ct in (56)
                </a>
            </li>
            <% } %>

            <% try { %>
            <li>
                <a href="?query=<%= encodeURIComponent(data.get_citing_query()) %>" class="query-link" target="_blank">
                    Documents citing <%= data.get_publication_number('epodoc') %>
                </a>
            </li>
            <% } catch(err) {} %>

        </ul>
    </div>

</script>
</%text>


<%text>
<script type="text/x-underscore-template" id="ops-biblio-party-template">
    <%
    original = _.escape(_.escape(original));
    epodoc = _.escape(_.escape(epodoc));
    %>
    <%= display %>
    &nbsp;
    <a href="#" class="incognito do-not-print" onclick="javascript: $(this).popover({
        html: true,
        content: 'original: <%= original %><br/>epodoc: <%= epodoc %>',
        trigger: 'manual'}); $(this).popover('toggle'); return false;">...</a>
</script>
</%text>



## ------------------------------------------
##   ops family templates
## ------------------------------------------
<%text>
<script id="ops-family-verbose-collection-template" type="text/x-underscore-template">

    <table class="table table-condensed">
        <thead>
        <tr>
            <th class="span1">PDF</th>
            <th class="span3">Publication</th>
            <th class="span3">Application</th>
            <th class="span2">Priority</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

</script>
<script id="ops-family-verbose-member-template" type="text/x-underscore-template">

    <%
    //log('family member:', data);
    var pubref = data.get_publication_reference(null, 'docdb');
    var appref = data.get_application_reference(null, 'docdb');
    var linkmaker = new Ipsuite.LinkMaker();
    %>

    <td>
        <!-- pdf document -->
        <a href="<%= linkmaker.universal_pdf_url(pubref.fullnumber) %>" target="ipsuite-pdf"
           class="btn btn-small btn-popover anchor-pdf do-not-print" role="button"
           data-toggle="popover" data-trigger="hover" data-placement="top"
           data-content="PDF document"
                >
            <%= opsChooserApp.ui.pdf_icon() %>
        </a>
    </td>
    <td>
        <%= data.enrich_link(pubref.fullnumber, 'pn') %>
        <br/>
        <%= pubref.isodate %>
    </td>
    <td>
        <%= appref.fullnumber %>
        <br/>
        <%= appref.isodate %>
        <%
        if (data['application-reference']['@is-representative'] == 'YES') {
            print('<br/>');
            print('representative: yes');
        }
        %>
    </td>
    <td>
        <%
        _(data['priority-claim']).each(function(priority) {
            //log('priority:', priority);
            var document_id = data.get_document_id(priority, null, 'docdb');
            print(document_id.fullnumber);
            print('<br/>');
            print(document_id.isodate);
            print('<br/>');
            if (priority['priority-active-indicator'] && priority['priority-active-indicator']['$'] == 'YES') {
                print('active: yes');
                print('<br/>');
            }
        });
        %>
    </td>

</script>


<script id="ops-family-compact-collection-template" type="text/x-underscore-template">
    <table class="table table-condensed span6">
        <thead>
        <tr>
            <th class="span1">PDF</th>
            <th class="span2">Publication</th>
            <th class="span2">Date</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <%
            var family_members = data.get_patent_family_member_list('epodoc');
            var family_members_comma = family_members.join(',');
            %>
            <td>
            </td>
            <td colspan="2">
                <a href="?numberlist=<%= encodeURIComponent(family_members_comma) %>" class="query-link" target="_blank">
                    All family members (#<%= family_members.length %>)
                </a>
            </td>
        </tr>
        </tbody>
    </table>
</script>
<script id="ops-family-compact-member-template" type="text/x-underscore-template">

    <%
    //log('family member:', data);
    var pubref = data.get_publication_reference(null, 'docdb');
    var linkmaker = new Ipsuite.LinkMaker();
    %>

    <td>
        <!-- pdf document -->
        <a href="<%= linkmaker.universal_pdf_url(pubref.fullnumber) %>" target="ipsuite-pdf"
           class="btn btn-small btn-popover anchor-pdf do-not-print" role="button"
           data-toggle="popover" data-trigger="hover" data-placement="top"
           data-content="PDF document"
                >
            <%= opsChooserApp.ui.pdf_icon() %>
        </a>
    </td>

    <td>
        <%= data.enrich_link(pubref.fullnumber, 'pn', null, null, {'no_modifiers': true}) %>
    </td>

    <td>
        <%= pubref.isodate %>
    </td>

</script>


<script id="ops-family-citations-collection-template" type="text/x-underscore-template">
    <table class="table table-condensed">
        <thead>
        <tr>
            <th class="span1">Explore</th>
            <th class="span2">Publication</th>
            <th class="span7">References cited</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td><%= data.get_citations_environment_button() %></td>
            <td></td>
            <td>Citation references from all family members (#<%= data.get_patent_citation_list(false, 'epodoc').length %>)</td>
        </tr>
        <tr>
            <td><%= data.get_citations_environment_button({members_no_us: true}) %></td>
            <td></td>
            <td>Citation references from non-US family members</td>
        </tr>
        </tbody>
    </table>
</script>
<script id="ops-family-citations-member-template" type="text/x-underscore-template">

    <%
    //log('family member:', data);
    var pubref = data.get_publication_reference(null, 'docdb');
    %>

    <td>
        <%= data.get_citations_environment_button() %>
    </td>

    <td>
        <%= data.enrich_link(pubref.fullnumber, 'pn', null, null, {'no_modifiers': true}) %>
        <br/>
        <%= pubref.isodate %>
    </td>

    <td>
        <%= data.get_patent_citation_list(true).join(', ') || '&nbsp;' %>
    </td>

</script>
</%text>


## ------------------------------------------
##   modal dialog for viewing pdf
## ------------------------------------------
<div id="ops-pdf-modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="ops-pdf-modal-label" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="ops-pdf-modal-label"></h3>
    </div>
    <div class="modal-body" id="pdf">
    </div>
    <div class="modal-footer">
        <div class="btn-group pull-left">
            <button class="btn btn-primary" id="pdf-previous">Previous</button>
            <button class="btn btn-primary" id="pdf-next">Next</button>
        </div>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    </div>
</div>
